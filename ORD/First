from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait, Select
from selenium.webdriver.support import expected_conditions as EC
import time

PATH = r"C:\Program Files (x86)\chromedriver.exe"
service = Service(PATH)

driver = webdriver.Chrome(service=service)

# Track clicked buttons to avoid duplicates
clicked_button_positions = []

def wait_ready(timeout=20):
    try:
        WebDriverWait(driver, timeout).until(lambda d: d.execute_script('return document.readyState') == 'complete')
    except Exception:
        time.sleep(1)


driver.get("https://open-reaction-database.org/")
wait_ready()

# Click Browse
try:
    browse = WebDriverWait(driver, 20).until(
        EC.element_to_be_clickable((By.CSS_SELECTOR, "a.nav-link[href='/browse']"))
    )
    browse.click()
except Exception:
    try:
        browse = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.LINK_TEXT, "Browse")))
        browse.click()
    except Exception:
        pass

# Wait for Browse page pagination
try:
    WebDriverWait(driver, 20).until(EC.visibility_of_element_located((By.CSS_SELECTOR, "div.pagination")))
except Exception:
    for _ in range(10):
        driver.execute_script("window.scrollBy(0, 300);")
        time.sleep(0.5)
        try:
            if driver.find_elements(By.CSS_SELECTOR, "div.pagination"):
                break
        except Exception:
            pass

# Ensure we can see the pagination select and set to 100
try:
    select_el = WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.CSS_SELECTOR, "select#pagination")))
    driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", select_el)
    time.sleep(0.5)
    try:
        Select(select_el).select_by_value('100')
        time.sleep(1)
    except Exception:
        try:
            driver.execute_script("var s = document.getElementById('pagination'); if(s){ s.value='100'; s.dispatchEvent(new Event('change')); }")
            time.sleep(1)
        except Exception:
            pass
    
    driver.execute_script("window.scrollTo(0, 0);")

    def wait_for_scroll_stable(timeout=6, check_interval=0.2, stable_checks=3):
        last = None
        stable = 0
        t0 = time.time()
        while time.time() - t0 < timeout:
            try:
                y = driver.execute_script("return window.pageYOffset || document.documentElement.scrollTop || 0;")
            except Exception:
                y = 0
            if last is None or abs(y - last) < 3:
                stable += 1
            else:
                stable = 0
            if stable >= stable_checks:
                return True
            last = y
            time.sleep(check_interval)
        return False

    wait_for_scroll_stable()
except Exception:
    pass

# Click first dataset
try:
    first_dataset = WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.CSS_SELECTOR, "a[href*='/dataset/ord_dataset-']"))
    )
    driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", first_dataset)
    try:
        wait_for_scroll_stable()
    except Exception:
        time.sleep(0.5)
    time.sleep(0.3)
    try:
        first_dataset = WebDriverWait(driver, 5).until(
            EC.element_to_be_clickable((By.CSS_SELECTOR, "a[href*='/dataset/ord_dataset-']"))
        )
        first_dataset.click()
    except Exception:
        driver.execute_script("document.querySelector(\"a[href*='/dataset/ord_dataset-']\").click();")
except Exception:
    try:
        driver.execute_script("document.querySelector(\"a[href*='/dataset/ord_dataset-']\").click();")
    except Exception:
        pass

# Wait dataset page to fully load
wait_ready(25)
time.sleep(3)

try:
    WebDriverWait(driver, 15).until(lambda d: d.execute_script("return document.body.textContent.length > 100"))
except Exception:
    time.sleep(2)

# Scroll down to find pagination
found_pagination = False
for _ in range(40):
    try:
        divs = driver.find_elements(By.CSS_SELECTOR, "div.select")
        for div in divs:
            txt = (div.text or "").strip()
            if "of 100 entries" in txt:
                driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", div)
                time.sleep(0.5)
                found_pagination = True
                break
        if found_pagination:
            break
    except Exception:
        pass
    driver.execute_script("window.scrollBy(0, 300);")
    time.sleep(0.5)

# Set pagination to 100
if found_pagination:
    try:
        select_el = WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.CSS_SELECTOR, "select#pagination")))
        driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", select_el)
        time.sleep(0.5)
        try:
            Select(select_el).select_by_value('100')
            time.sleep(1)
        except Exception:
            try:
                driver.execute_script("var s = document.getElementById('pagination'); if(s){ s.value='100'; s.dispatchEvent(new Event('change')); }")
                time.sleep(1)
            except Exception:
                pass
    except Exception:
        pass

# Scroll to top
driver.execute_script("window.scrollTo(0, 0);")
time.sleep(1)

# Click View Full Details
try:
    driver.execute_script("window.scrollBy(0,100);")
    view_btn = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "//button[contains(text(), 'View Full Details') or contains(., 'View Full Details')]")))
    view_btn.click()
    wait_ready(10)
    time.sleep(5)
    print("✓ Clicked View Full Details")
    
    # Wait longer for tabs to load
    WebDriverWait(driver, 15).until(lambda d: len(d.find_elements(By.CSS_SELECTOR, "div.tab")) > 0)
    time.sleep(2)
    
except Exception as e:
    print(f"Error clicking View Full Details: {e}")

# Click the "base" tab first
try:
    time.sleep(1)
    tabs = driver.find_elements(By.CSS_SELECTOR, "div.tab")
    
    for tab in tabs:
        txt = (tab.text or "").strip().lower()
        if "base" == txt:
            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", tab)
            time.sleep(0.3)
            try:
                tab.click()
                print("✓ Clicked base tab")
            except Exception:
                try:
                    driver.execute_script("arguments[0].click();", tab)
                    print("✓ Clicked base tab (JS)")
                except Exception:
                    pass
            time.sleep(1)
            break
    else:
        print("⚠ Base tab not found")

    # Find and click the <> icon button in the base section
    try:
        buttons = driver.find_elements(By.CSS_SELECTOR, "div.button")
        for btn in buttons:
            inner_html = (btn.get_attribute("innerHTML") or "").strip()
            inner_text = (btn.text or "").strip()
            if "<>" in inner_text or "&lt;&gt;" in inner_html or "<>" in inner_html:
                btn_pos = (btn.location.get('x', 0), btn.location.get('y', 0))
                if btn_pos not in clicked_button_positions:
                    clicked_button_positions.append(btn_pos)
                    driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", btn)
                    time.sleep(0.3)
                    try:
                        btn.click()
                        print("✓ Clicked base <> button")
                    except Exception:
                        try:
                            driver.execute_script("arguments[0].click();", btn)
                            print("✓ Clicked base <> button (JS)")
                        except Exception:
                            pass
                    time.sleep(1)
                    break
    except Exception:
        pass

    # Extract base identifier and reaction_role
    import re
    time.sleep(0.8)
    pre_elements = driver.find_elements(By.CSS_SELECTOR, "pre, code")
    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "identifiers" in text and "value" in text:
            m = re.search(r'"value"\s*:\s*"([^"]+)"', text)
            if m:
                base_identifier = m.group(0)
                print(f"✓ Copied base identifier: {base_identifier}")
                try:
                    import pyperclip
                    pyperclip.copy(base_identifier)
                except Exception:
                    pass
                break

    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "reaction_role" in text:
            m2 = re.search(r'reaction_role\s*:\s*([A-Z_]+)', text)
            if m2:
                base_reaction_role = m2.group(1)
                print(f"✓ Copied base reaction_role: {base_reaction_role}")
                try:
                    import pyperclip
                    pyperclip.copy(base_reaction_role)
                except Exception:
                    pass
                break

    # Close base code view
    try:
        close_el = None
        try:
            close_el = driver.find_element(By.CSS_SELECTOR, "div[data-v-419ab5e1].close")
        except Exception:
            close_el = None
        if not close_el:
            for d in driver.find_elements(By.CSS_SELECTOR, "div.close"):
                if '✕' in (d.text or '') or '✕' in (d.get_attribute('innerHTML') or ''):
                    close_el = d
                    break
        if close_el:
            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", close_el)
            time.sleep(0.2)
            try:
                close_el.click()
                print("✓ Closed base code view")
            except Exception:
                driver.execute_script("arguments[0].click();", close_el)
                print("✓ Closed base code view (JS)")
            try:
                WebDriverWait(driver, 4).until(EC.invisibility_of_element_located((By.CSS_SELECTOR, "div[data-v-419ab5e1].close")))
            except Exception:
                time.sleep(0.4)
    except Exception:
        pass
except Exception as e:
    print(f"Exception in base tab: {e}")

# Click the "Solvent" tab
try:
    tabs = driver.find_elements(By.CSS_SELECTOR, "div.tab")
    for tab in tabs:
        txt = (tab.text or "").strip()
        if "Solvent" in txt or "solvent" in txt.lower():
            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", tab)
            time.sleep(0.3)
            try:
                tab.click()
                print("✓ Clicked Solvent tab")
            except Exception:
                try:
                    driver.execute_script("arguments[0].click();", tab)
                    print("✓ Clicked Solvent tab (JS)")
                except Exception:
                    pass
            time.sleep(1)
            break

    # Find and click the <> icon button in the Solvent section
    try:
        buttons = driver.find_elements(By.CSS_SELECTOR, "div.button")
        for btn in buttons:
            inner_html = (btn.get_attribute("innerHTML") or "").strip()
            inner_text = (btn.text or "").strip()
            if "<>" in inner_text or "&lt;&gt;" in inner_html or "<>" in inner_html:
                btn_pos = (btn.location.get('x', 0), btn.location.get('y', 0))
                if btn_pos not in clicked_button_positions:
                    clicked_button_positions.append(btn_pos)
                    driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", btn)
                    time.sleep(0.3)
                    try:
                        btn.click()
                        print("✓ Clicked Solvent <> button")
                    except Exception:
                        try:
                            driver.execute_script("arguments[0].click();", btn)
                            print("✓ Clicked Solvent <> button (JS)")
                        except Exception:
                            pass
                    time.sleep(1)
                    break
    except Exception:
        pass

    # Extract solvent identifier and reaction_role
    import re
    time.sleep(0.8)
    pre_elements = driver.find_elements(By.CSS_SELECTOR, "pre, code")
    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "identifiers" in text and "value" in text:
            m = re.search(r'"value"\s*:\s*"([^"]+)"', text)
            if m:
                solvent_identifier = m.group(0)
                print(f"✓ Copied solvent identifier: {solvent_identifier}")
                try:
                    import pyperclip
                    pyperclip.copy(solvent_identifier)
                except Exception:
                    pass
                break

    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "reaction_role" in text:
            m2 = re.search(r'reaction_role\s*:\s*([A-Z_]+)', text)
            if m2:
                solvent_reaction_role = m2.group(1)
                print(f"✓ Copied solvent reaction_role: {solvent_reaction_role}")
                try:
                    import pyperclip
                    pyperclip.copy(solvent_reaction_role)
                except Exception:
                    pass
                break

    # Close solvent code view
    try:
        close_el = None
        try:
            close_el = driver.find_element(By.CSS_SELECTOR, "div[data-v-419ab5e1].close")
        except Exception:
            close_el = None
        if not close_el:
            for d in driver.find_elements(By.CSS_SELECTOR, "div.close"):
                if '✕' in (d.text or '') or '✕' in (d.get_attribute('innerHTML') or ''):
                    close_el = d
                    break
        if close_el:
            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", close_el)
            time.sleep(0.2)
            try:
                close_el.click()
                print("✓ Closed solvent code view")
            except Exception:
                driver.execute_script("arguments[0].click();", close_el)
                print("✓ Closed solvent code view (JS)")
            try:
                WebDriverWait(driver, 4).until(EC.invisibility_of_element_located((By.CSS_SELECTOR, "div[data-v-419ab5e1].close")))
            except Exception:
                time.sleep(0.4)
    except Exception:
        pass
except Exception as e:
    print(f"Exception in Solvent tab: {e}")

# Click the "amine" tab
try:
    amine_tab = None
    for tab in driver.find_elements(By.CSS_SELECTOR, "div.tab"):
        try:
            tab_text = (tab.text or '').strip().lower()
            if tab_text == 'amine':
                amine_tab = tab
                break
        except Exception:
            pass

    if amine_tab:
        try:
            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", amine_tab)
            time.sleep(0.3)
            try:
                amine_tab.click()
                print("✓ Clicked amine tab")
            except Exception:
                try:
                    driver.execute_script("arguments[0].click();", amine_tab)
                    print("✓ Clicked amine tab (JS)")
                except Exception:
                    pass
            time.sleep(1)
        except Exception as e:
            print(f"Error clicking amine tab: {e}")
    else:
        print("⚠ Amine tab not found")

    # Find and click <> button in amine section
    code_btn = None
    try:
        buttons = driver.find_elements(By.CSS_SELECTOR, "div.button")
        for btn in buttons:
            inner_html = (btn.get_attribute("innerHTML") or "").strip()
            inner_text = (btn.text or "").strip()
            if "<>" in inner_text or "&lt;&gt;" in inner_html or "<>" in inner_html:
                btn_pos = (btn.location.get('x', 0), btn.location.get('y', 0))
                if btn_pos not in clicked_button_positions:
                    code_btn = btn
                    clicked_button_positions.append(btn_pos)
                    break
    except Exception:
        pass

    if code_btn:
        driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", code_btn)
        time.sleep(0.3)
        try:
            code_btn.click()
            print("✓ Clicked amine <> button")
        except Exception:
            driver.execute_script("arguments[0].click();", code_btn)
            print("✓ Clicked amine <> button (JS)")
        time.sleep(1)

    # Extract amine identifier and reaction_role
    import re
    time.sleep(0.8)
    pre_elements = driver.find_elements(By.CSS_SELECTOR, "pre, code")
    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "identifiers" in text and "value" in text:
            m = re.search(r'"value"\s*:\s*"([^"]+)"', text)
            if m:
                amine_identifier_value = m.group(0)
                print(f"✓ Copied amine identifier: {amine_identifier_value}")
                try:
                    import pyperclip
                    pyperclip.copy(amine_identifier_value)
                except Exception:
                    pass
                break

    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "reaction_role" in text:
            m2 = re.search(r'reaction_role\s*:\s*([A-Z_]+)', text)
            if m2:
                amine_reaction_role = m2.group(1)
                print(f"✓ Copied amine reaction_role: {amine_reaction_role}")
                try:
                    import pyperclip
                    pyperclip.copy(amine_reaction_role)
                except Exception:
                    pass
                break

    # Close amine code view
    try:
        close_el = None
        try:
            close_el = driver.find_element(By.CSS_SELECTOR, "div[data-v-419ab5e1].close")
        except Exception:
            close_el = None
        if not close_el:
            for d in driver.find_elements(By.CSS_SELECTOR, "div.close"):
                if '✕' in (d.text or '') or '✕' in (d.get_attribute('innerHTML') or ''):
                    close_el = d
                    break
        if close_el:
            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", close_el)
            time.sleep(0.2)
            try:
                close_el.click()
                print("✓ Closed amine code view")
            except Exception:
                driver.execute_script("arguments[0].click();", close_el)
                print("✓ Closed amine code view (JS)")
            try:
                WebDriverWait(driver, 4).until(EC.invisibility_of_element_located((By.CSS_SELECTOR, "div[data-v-419ab5e1].close")))
            except Exception:
                time.sleep(0.4)
    except Exception:
        pass
except Exception as e:
    print(f"Exception in amine tab: {e}")

# Click the "aryl halide" tab
try:
    aryl_halide_tab = None
    for tab in driver.find_elements(By.CSS_SELECTOR, "div.tab"):
        try:
            tab_text = (tab.text or '').strip().lower()
            if tab_text == 'aryl halide':
                aryl_halide_tab = tab
                break
        except Exception:
            pass

    if aryl_halide_tab:
        print(f"Found aryl halide tab")
        driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", aryl_halide_tab)
        time.sleep(0.3)
        try:
            aryl_halide_tab.click()
            print("✓ Clicked aryl halide tab")
        except Exception:
            driver.execute_script("arguments[0].click();", aryl_halide_tab)
            print("✓ Clicked aryl halide tab (JS)")
        time.sleep(1)

    # Find and click first <> button (aryl halide)
    code_btn = None
    buttons = driver.find_elements(By.CSS_SELECTOR, "div.button")
    for btn in buttons:
        inner_html = (btn.get_attribute("innerHTML") or "").strip()
        inner_text = (btn.text or "").strip()
        if "<>" in inner_text or "&lt;&gt;" in inner_html:
            btn_pos = (btn.location.get('x', 0), btn.location.get('y', 0))
            if btn_pos not in clicked_button_positions:
                code_btn = btn
                clicked_button_positions.append(btn_pos)
                break

    if code_btn:
        driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", code_btn)
        time.sleep(0.3)
        try:
            code_btn.click()
            print("✓ Clicked aryl halide <> button")
        except Exception:
            driver.execute_script("arguments[0].click();", code_btn)
            print("✓ Clicked aryl halide <> button (JS)")
        time.sleep(1)

    # Extract aryl halide identifier and reaction_role
    import re
    time.sleep(0.8)
    pre_elements = driver.find_elements(By.CSS_SELECTOR, "pre, code")
    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "identifiers" in text and "value" in text:
            m = re.search(r'"value"\s*:\s*"([^"]+)"', text)
            if m:
                aryl_halide_identifier_value = m.group(0)
                print(f"✓ Copied aryl halide identifier: {aryl_halide_identifier_value}")
                try:
                    import pyperclip
                    pyperclip.copy(aryl_halide_identifier_value)
                except Exception:
                    pass
                break

    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "reaction_role" in text:
            m2 = re.search(r'reaction_role\s*:\s*([A-Z_]+)', text)
            if m2:
                aryl_halide_reaction_role = m2.group(1)
                print(f"✓ Copied aryl halide reaction_role: {aryl_halide_reaction_role}")
                try:
                    import pyperclip
                    pyperclip.copy(aryl_halide_reaction_role)
                except Exception:
                    pass
                break

    # Close aryl halide code view
    try:
        close_el = None
        try:
            close_el = driver.find_element(By.CSS_SELECTOR, "div[data-v-419ab5e1].close")
        except Exception:
            close_el = None
        if not close_el:
            for d in driver.find_elements(By.CSS_SELECTOR, "div.close"):
                if '✕' in (d.text or '') or '✕' in (d.get_attribute('innerHTML') or ''):
                    close_el = d
                    break
        if close_el:
            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", close_el)
            time.sleep(0.2)
            try:
                close_el.click()
                print("✓ Closed aryl halide code view")
            except Exception:
                driver.execute_script("arguments[0].click();", close_el)
                print("✓ Closed aryl halide code view (JS)")
            try:
                WebDriverWait(driver, 4).until(EC.invisibility_of_element_located((By.CSS_SELECTOR, "div[data-v-419ab5e1].close")))
            except Exception:
                time.sleep(0.4)
    except Exception:
        pass
    
    if not aryl_halide_tab:
        print("⚠ Aryl halide tab not found")
except Exception as e:
    print(f"Exception in aryl halide tab: {e}")

# Click the "metal and ligand" tab
try:
    metal_ligand_tab = None
    for tab in driver.find_elements(By.CSS_SELECTOR, "div.tab"):
        try:
            tab_text = (tab.text or '').strip().lower()
            if tab_text == 'metal and ligand':
                metal_ligand_tab = tab
                break
        except Exception:
            pass

    if metal_ligand_tab:
        print(f"Found metal and ligand tab")
        driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", metal_ligand_tab)
        time.sleep(0.3)
        try:
            metal_ligand_tab.click()
            print("✓ Clicked metal and ligand tab")
        except Exception:
            driver.execute_script("arguments[0].click();", metal_ligand_tab)
            print("✓ Clicked metal and ligand tab (JS)")
        time.sleep(1)

    # Find and click <> button
    code_btn = None
    buttons = driver.find_elements(By.CSS_SELECTOR, "div.button")
    for btn in buttons:
        inner_html = (btn.get_attribute("innerHTML") or "").strip()
        inner_text = (btn.text or "").strip()
        if "<>" in inner_text or "&lt;&gt;" in inner_html:
            btn_pos = (btn.location.get('x', 0), btn.location.get('y', 0))
            if btn_pos not in clicked_button_positions:
                code_btn = btn
                clicked_button_positions.append(btn_pos)
                break

    if code_btn:
        driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", code_btn)
        time.sleep(0.3)
        try:
            code_btn.click()
            print("✓ Clicked metal and ligand <> button")
        except Exception:
            driver.execute_script("arguments[0].click();", code_btn)
            print("✓ Clicked metal and ligand <> button (JS)")
        time.sleep(1)

    # Extract metal and ligand identifier and reaction_role
    import re
    time.sleep(0.8)
    pre_elements = driver.find_elements(By.CSS_SELECTOR, "pre, code")
    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "identifiers" in text and "value" in text:
            m = re.search(r'"value"\s*:\s*"([^"]+)"', text)
            if m:
                metal_ligand_identifier_value = m.group(0)
                print(f"✓ Copied metal and ligand identifier: {metal_ligand_identifier_value}")
                try:
                    import pyperclip
                    pyperclip.copy(metal_ligand_identifier_value)
                except Exception:
                    pass
                break

    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "reaction_role" in text:
            m2 = re.search(r'reaction_role\s*:\s*([A-Z_]+)', text)
            if m2:
                metal_ligand_reaction_role = m2.group(1)
                print(f"✓ Copied metal and ligand reaction_role: {metal_ligand_reaction_role}")
                try:
                    import pyperclip
                    pyperclip.copy(metal_ligand_reaction_role)
                except Exception:
                    pass
                break

    # Close metal and ligand code view
    try:
        close_el = None
        try:
            close_el = driver.find_element(By.CSS_SELECTOR, "div[data-v-419ab5e1].close")
        except Exception:
            close_el = None
        if not close_el:
            for d in driver.find_elements(By.CSS_SELECTOR, "div.close"):
                if '✕' in (d.text or '') or '✕' in (d.get_attribute('innerHTML') or ''):
                    close_el = d
                    break
        if close_el:
            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", close_el)
            time.sleep(0.2)
            try:
                close_el.click()
                print("✓ Closed metal and ligand code view")
            except Exception:
                driver.execute_script("arguments[0].click();", close_el)
                print("✓ Closed metal and ligand code view (JS)")
            try:
                WebDriverWait(driver, 4).until(EC.invisibility_of_element_located((By.CSS_SELECTOR, "div[data-v-419ab5e1].close")))
            except Exception:
                time.sleep(0.4)
    except Exception:
        pass
    
    if not metal_ligand_tab:
        print("⚠ Metal and ligand tab not found")
except Exception as e:
    print(f"Exception in metal and ligand tab: {e}")

# Find and click identifiers <> button (data-v-144eb116) on current identifiers page
try:
    time.sleep(0.5)
    identifiers_code_btn = None
    buttons = driver.find_elements(By.CSS_SELECTOR, "div[data-v-144eb116].button")
    for btn in buttons:
        inner_html = (btn.get_attribute("innerHTML") or "").strip()
        inner_text = (btn.text or "").strip()
        if "<>" in inner_text or "&lt;&gt;" in inner_html:
            btn_pos = (btn.location.get('x', 0), btn.location.get('y', 0))
            if btn_pos not in clicked_button_positions:
                identifiers_code_btn = btn
                clicked_button_positions.append(btn_pos)
                break

    if identifiers_code_btn:
        driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", identifiers_code_btn)
        time.sleep(0.3)
        try:
            identifiers_code_btn.click()
            print("✓ Clicked identifiers <> button")
        except Exception:
            driver.execute_script("arguments[0].click();", identifiers_code_btn)
            print("✓ Clicked identifiers <> button (JS)")
        time.sleep(1)

    # Extract identifiers raw data
    import re
    time.sleep(0.8)
    pre_elements = driver.find_elements(By.CSS_SELECTOR, "pre, code")
    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "identifiers" in text and "value" in text:
            m = re.search(r'"value"\s*:\s*"([^"]+)"', text)
            if m:
                identifiers_value = m.group(0)
                print(f"✓ Copied identifiers value: {identifiers_value}")
                try:
                    import pyperclip
                    pyperclip.copy(identifiers_value)
                except Exception:
                    pass
                break

    for pre in pre_elements:
        try:
            text = (pre.text or "").strip()
        except Exception:
            text = ""
        if "reaction_role" in text:
            m2 = re.search(r'reaction_role\s*:\s*([A-Z_]+)', text)
            if m2:
                identifiers_reaction_role = m2.group(1)
                print(f"✓ Copied identifiers reaction_role: {identifiers_reaction_role}")
                try:
                    import pyperclip
                    pyperclip.copy(identifiers_reaction_role)
                except Exception:
                    pass
                break

    # Close identifiers code view
    try:
        close_el = None
        try:
            close_el = driver.find_element(By.CSS_SELECTOR, "div[data-v-419ab5e1].close")
        except Exception:
            close_el = None
        if not close_el:
            for d in driver.find_elements(By.CSS_SELECTOR, "div.close"):
                if '✕' in (d.text or '') or '✕' in (d.get_attribute('innerHTML') or ''):
                    close_el = d
                    break
        if close_el:
            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", close_el)
            time.sleep(0.2)
            try:
                close_el.click()
                print("✓ Closed identifiers code view")
            except Exception:
                driver.execute_script("arguments[0].click();", close_el)
                print("✓ Closed identifiers code view (JS)")
            try:
                WebDriverWait(driver, 4).until(EC.invisibility_of_element_located((By.CSS_SELECTOR, "div[data-v-419ab5e1].close")))
            except Exception:
                time.sleep(0.4)
    except Exception:
        pass
    
    if not identifiers_code_btn:
        print("⚠ Identifiers <> button not found")
except Exception as e:
    print(f"Exception in identifiers section: {e}")

# Scroll down to find outcomes section
try:
    print("Scrolling to find outcomes section...")
    outcomes_found = False
    
    for _ in range(20):
        try:
            outcomes_nav = driver.find_element(By.CSS_SELECTOR, "div[data-v-7f5b0fb9].nav-item.active")
            if outcomes_nav:
                outcomes_text = (outcomes_nav.text or "").strip().lower()
                if "outcomes" in outcomes_text:
                    driver.execute_script("arguments[0].scrollIntoView({behavior: 'smooth', block: 'center'});", outcomes_nav)
                    time.sleep(0.6)
                    outcomes_found = True
                    print("✓ Found outcomes section")
                    break
        except Exception:
            pass
        driver.execute_script("window.scrollBy(0, 300);")
        time.sleep(0.35)
    
    if outcomes_found:
        # Find and click outcomes <> button (data-v-144eb116)
        time.sleep(0.5)
        outcomes_code_btn = None
        
        buttons = driver.find_elements(By.CSS_SELECTOR, "div[data-v-144eb116].button")
        for btn in buttons:
            try:
                inner_html = (btn.get_attribute("innerHTML") or "").strip()
                inner_text = (btn.text or "").strip()
                if "<>" in inner_text or "&lt;&gt;" in inner_html:
                    pos = (btn.location.get('x', 0), btn.location.get('y', 0))
                    if pos not in clicked_button_positions:
                        outcomes_code_btn = btn
                        break
            except Exception:
                pass
        
        if outcomes_code_btn:
            time.sleep(0.3)
            pos = (outcomes_code_btn.location.get('x', 0), outcomes_code_btn.location.get('y', 0))
            clicked_button_positions.append(pos)
            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", outcomes_code_btn)
            time.sleep(0.3)
            try:
                outcomes_code_btn.click()
                print("✓ Clicked outcomes <> button")
            except Exception:
                driver.execute_script("arguments[0].click();", outcomes_code_btn)
                print("✓ Clicked outcomes <> button (JS)")
            time.sleep(1)
            
            # Extract outcomes identifier value and reaction_role
            import re
            time.sleep(0.8)
            pre_elements = driver.find_elements(By.CSS_SELECTOR, "pre, code")
            for pre in pre_elements:
                try:
                    text = (pre.text or "").strip()
                except Exception:
                    text = ""
                
                if "identifiers" in text and "value" in text:
                    m = re.search(r'"value"\s*:\s*"([^"]+)"', text)
                    if m:
                        outcomes_identifier_value = m.group(0)
                        print(f"✓ Copied outcomes identifier value: {outcomes_identifier_value}")
                        try:
                            import pyperclip
                            pyperclip.copy(outcomes_identifier_value)
                        except Exception:
                            pass
                
                if "reaction_role" in text:
                    m2 = re.search(r'reaction_role\s*:\s*([A-Z_]+)', text)
                    if m2:
                        outcomes_reaction_role = m2.group(1)
                        print(f"✓ Copied outcomes reaction_role: {outcomes_reaction_role}")
                        try:
                            import pyperclip
                            pyperclip.copy(outcomes_reaction_role)
                        except Exception:
                            pass
            
            # Close outcomes code view
            try:
                close_el = None
                try:
                    close_el = driver.find_element(By.CSS_SELECTOR, "div[data-v-419ab5e1].close")
                except Exception:
                    close_el = None
                if not close_el:
                    for d in driver.find_elements(By.CSS_SELECTOR, "div.close"):
                        if '✕' in (d.text or '') or '✕' in (d.get_attribute('innerHTML') or ''):
                            close_el = d
                            break
                if close_el:
                    driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", close_el)
                    time.sleep(0.2)
                    try:
                        close_el.click()
                        print("✓ Closed outcomes code view")
                    except Exception:
                        driver.execute_script("arguments[0].click();", close_el)
                        print("✓ Closed outcomes code view (JS)")
                    try:
                        WebDriverWait(driver, 4).until(EC.invisibility_of_element_located((By.CSS_SELECTOR, "div[data-v-419ab5e1].close")))
                    except Exception:
                        time.sleep(0.4)
            except Exception:
                pass
            
            # Find and click measurement <> button (data-v-5fabe866)
            try:
                time.sleep(0.5)
                measurement_code_btn = None
                
                buttons = driver.find_elements(By.CSS_SELECTOR, "div[data-v-5fabe866].button")
                for btn in buttons:
                    try:
                        inner_html = (btn.get_attribute("innerHTML") or "").strip()
                        inner_text = (btn.text or "").strip()
                        if "<>" in inner_text or "&lt;&gt;" in inner_html:
                            pos = (btn.location.get('x', 0), btn.location.get('y', 0))
                            if pos not in clicked_button_positions:
                                measurement_code_btn = btn
                                break
                    except Exception:
                        pass
                
                if measurement_code_btn:
                    time.sleep(0.3)
                    pos = (measurement_code_btn.location.get('x', 0), measurement_code_btn.location.get('y', 0))
                    clicked_button_positions.append(pos)
                    driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", measurement_code_btn)
                    time.sleep(0.3)
                    try:
                        measurement_code_btn.click()
                        print("✓ Clicked measurement <> button")
                    except Exception:
                        driver.execute_script("arguments[0].click();", measurement_code_btn)
                        print("✓ Clicked measurement <> button (JS)")
                    time.sleep(1)
                    
                    # Extract measurement type and value
                    import re
                    time.sleep(0.8)
                    pre_elements = driver.find_elements(By.CSS_SELECTOR, "pre, code")
                    for pre in pre_elements:
                        try:
                            text = (pre.text or "").strip()
                        except Exception:
                            text = ""
                        
                        if '"type"' in text and "YIELD" in text:
                            m_type = re.search(r'"type"\s*:\s*"([^"]+)"', text)
                            if m_type:
                                measurement_type = m_type.group(0)
                                print(f"✓ Copied measurement type: {measurement_type}")
                                try:
                                    import pyperclip
                                    pyperclip.copy(measurement_type)
                                except Exception:
                                    pass
                        
                        if '"value"' in text and ("percentage" in text or "[0-9]" in text):
                            m_value = re.search(r'"value"\s*:\s*([0-9.]+)', text)
                            if m_value:
                                measurement_value = m_value.group(0)
                                print(f"✓ Copied measurement value: {measurement_value}")
                                try:
                                    import pyperclip
                                    pyperclip.copy(measurement_value)
                                except Exception:
                                    pass
                    
                    # Close measurement code view
                    try:
                        close_el = None
                        try:
                            close_el = driver.find_element(By.CSS_SELECTOR, "div[data-v-419ab5e1].close")
                        except Exception:
                            close_el = None
                        if not close_el:
                            for d in driver.find_elements(By.CSS_SELECTOR, "div.close"):
                                if '✕' in (d.text or '') or '✕' in (d.get_attribute('innerHTML') or ''):
                                    close_el = d
                                    break
                        if close_el:
                            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", close_el)
                            time.sleep(0.2)
                            try:
                                close_el.click()
                                print("✓ Closed measurement code view")
                            except Exception:
                                driver.execute_script("arguments[0].click();", close_el)
                                print("✓ Closed measurement code view (JS)")
                            try:
                                WebDriverWait(driver, 4).until(EC.invisibility_of_element_located((By.CSS_SELECTOR, "div[data-v-419ab5e1].close")))
                            except Exception:
                                time.sleep(0.4)
                    except Exception:
                        pass
                else:
                    print("⚠ Measurement <> button not found")
            except Exception as e:
                print(f"Exception clicking measurement button: {e}")
        else:
            print("⚠ Outcomes <> button not found")
    else:
        print("⚠ Outcomes section not found")
except Exception as e:
    print(f"Exception in outcomes section: {e}")

# Keep browser open for inspection
time.sleep(10)
driver.quit()
